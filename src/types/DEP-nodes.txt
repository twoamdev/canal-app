import type { Node as ReactFlowNode } from '@xyflow/react';
import type { OPFSFileMetadata } from '../utils/opfs';

/**
 * Base node data - this is just the DATA part of a node
 * It goes inside node.data, not the entire node
 */
export interface BaseNodeData {
  label: string;
  [key: string]: unknown;
}

// =============================================================================
// Time and Format Types
// =============================================================================

/**
 * Node time range - defines when a node is active on the timeline
 */
export interface NodeTimeRange {
  inFrame: number;        // First frame this node is active (inclusive)
  outFrame: number;       // Last frame this node is active (exclusive)
  sourceOffset?: number;  // For videos: which source frame maps to inFrame
}

/**
 * Node format - defines the output dimensions of a node
 */
export interface NodeFormat {
  width: number;
  height: number;
}

/**
 * Extracted frames metadata (persisted)
 */
export interface ExtractedFramesInfo {
  frameCount: number;
  format: 'webp' | 'png' | 'jpeg';
  width: number;
  height: number;
  duration: number;
  currentFrameIndex: number; // Last viewed frame (persisted for preview)
}

/**
 * Effect configuration for GPU processing (used internally)
 */
export interface EffectConfig {
  id: string;
  effectName: string;
  parameters: Record<string, number | number[] | boolean>;
  enabled: boolean;
}

// =============================================================================
// Effect Node Data Types
// =============================================================================

/**
 * Base data for all effect nodes
 */
export interface EffectNodeData extends BaseNodeData {
  // Parameters specific to the effect (e.g., { radius: 10 } for blur)
  parameters: Record<string, number | number[] | boolean | string>;
}

/**
 * Blur node data
 */
export interface BlurNodeData extends EffectNodeData {
  parameters: {
    radius: number;
  };
}

/**
 * Color adjustment node data
 */
export interface ColorAdjustNodeData extends EffectNodeData {
  parameters: {
    brightness: number;
    contrast: number;
    saturation: number;
    exposure: number;
  };
}

/**
 * Blend modes for merge operations
 */
export type MergeBlendMode = 'over' | 'under' | 'add' | 'subtract' | 'screen' | 'overlay';

/**
 * Merge node data - composites two inputs with blend modes
 */
export interface MergeNodeData extends EffectNodeData {
  parameters: {
    blendMode: MergeBlendMode;
    opacity: number;  // 0-1, foreground layer opacity
  };
}

/**
 * File node data - base for all file-based nodes
 * File is optional to support empty placeholder nodes
 */
export interface FileNodeData extends BaseNodeData {
  file?: OPFSFileMetadata;
}

/**
 * Video node data - extends file node with video-specific features
 */
export interface VideoNodeData extends FileNodeData {
  extractedFrames?: ExtractedFramesInfo;
  timeRange?: NodeTimeRange;  // Defaults: { inFrame: 0, outFrame: frameCount, sourceOffset: 0 }
  format?: NodeFormat;        // Defaults to native video dimensions
}

/**
 * Image node data - extends file node with image-specific features
 */
export interface ImageNodeData extends FileNodeData {
  nativeDimensions?: NodeFormat;  // Native image dimensions (persisted on load)
  timeRange?: NodeTimeRange;      // Defaults: inherit from global timeline
  format?: NodeFormat;            // Defaults to nativeDimensions
}

/**
 * Node type definitions
 */
export type FileNode = ReactFlowNode<FileNodeData, 'file'>;
export type VideoNode = ReactFlowNode<VideoNodeData, 'video'>;
export type ImageNode = ReactFlowNode<ImageNodeData, 'image'>;
export type BlurNode = ReactFlowNode<BlurNodeData, 'blur'>;
export type ColorAdjustNode = ReactFlowNode<ColorAdjustNodeData, 'colorAdjust'>;
export type MergeNode = ReactFlowNode<MergeNodeData, 'merge'>;

/**
 * Type alias for any node with base data
 */
export type CustomNode<T extends BaseNodeData = BaseNodeData> = ReactFlowNode<T>;

/**
 * Union type of all possible node types in the graph
 */
export type GraphNode = FileNode | VideoNode | ImageNode | BlurNode | ColorAdjustNode | MergeNode;

// Helper type to extract node data type from a node
export type NodeData<T extends GraphNode> = T extends ReactFlowNode<infer D> ? D : never;

/**
 * Node registry - defines available node types for the command menu
 */
export interface NodeTypeDefinition {
  type: string;
  label: string;
  description: string;
  icon: string; // Lucide icon name
  category: 'input' | 'effect' | 'transform' | 'output' | 'utility';
  acceptsMimeTypes?: string[]; // For file-based nodes
  defaultData?: Record<string, unknown>; // Default data for new nodes
}

export const NODE_REGISTRY: NodeTypeDefinition[] = [
  // Input nodes
  {
    type: 'video',
    label: 'Video',
    description: 'Import and process video files',
    icon: 'FileVideo',
    category: 'input',
    acceptsMimeTypes: ['video/*'],
  },

  {
    type: 'image',
    label: 'Image',
    description: 'Import PNG or JPG images',
    icon: 'Image',
    category: 'input',
    acceptsMimeTypes: ['image/png', 'image/jpeg'],
  },
  {
    type: 'file',
    label: 'File',
    description: 'Generic file import',
    icon: 'File',
    category: 'input',
    acceptsMimeTypes: ['*/*'],
  },
  // Effect nodes
  {
    type: 'blur',
    label: 'Blur',
    description: 'Gaussian blur effect',
    icon: 'CircleDot',
    category: 'effect',
    defaultData: {
      label: 'Blur',
      parameters: { radius: 10 },
    },
  },
  {
    type: 'colorAdjust',
    label: 'Color Adjust',
    description: 'Brightness, contrast, saturation',
    icon: 'Palette',
    category: 'effect',
    defaultData: {
      label: 'Color Adjust',
      parameters: {
        brightness: 0,
        contrast: 1,
        saturation: 1,
        exposure: 0,
      },
    },
  },
  {
    type: 'merge',
    label: 'Merge',
    description: 'Combine two layers with blend modes',
    icon: 'Layers',
    category: 'effect',
    defaultData: {
      label: 'Merge',
      parameters: {
        blendMode: 'over',
        opacity: 1,
      },
    },
  },

];

/**
 * File-based node types
 */
export type FileBasedNodeType = 'file' | 'video' | 'image';

/**
 * Supported image MIME types for ImageNode
 */
const SUPPORTED_IMAGE_TYPES = ['image/png', 'image/jpeg', 'image/jpg'];

/**
 * Get the appropriate node type for a given MIME type
 */
export function getNodeTypeForMimeType(mimeType: string): FileBasedNodeType {
  if (mimeType.startsWith('video/')) return 'video';
  if (SUPPORTED_IMAGE_TYPES.includes(mimeType)) return 'image';
  return 'file';
}
